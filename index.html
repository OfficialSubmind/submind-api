<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SubMind — OneClick Max</title>
  <link href="https://unpkg.com/milligram@1.4.1/dist/milligram.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body{background:#0d1117;color:#e6edf3}
    .container{max-width:1150px;margin:24px auto}
    .card{background:#161b22;border-radius:12px;padding:16px;margin-bottom:16px;border:1px solid #30363d}
    .row{display:flex;gap:16px;flex-wrap:wrap}
    .col{flex:1 1 48%}
    ul{margin:0;padding-left:18px}
    small.badge{background:#21262d;padding:2px 8px;border-radius:12px;border:1px solid #30363d}
    .pill{display:inline-block;background:#1f6feb;padding:2px 8px;border-radius:10px;margin-left:8px}
    canvas{background:#0d1117}
    a{color:#58a6ff}
    h3{margin-bottom:6px}
    .muted{opacity:.75}
  </style>
</head>
<body>
<div class="container">
  <div class="card">
    <h3>SubMind Live <small class="badge" id="ver"></small></h3>
    <p class="muted">All-in-one service: API + background worker + UI + streaming (SSE) + SQLite persistence.</p>
    <p>
      <a href="/health" target="_blank">Health</a> ·
      <a href="/api/scores" target="_blank">Scores API</a> ·
      <a href="/api/narratives" target="_blank">Narratives API</a> ·
      <a href="/api/incidents" target="_blank">Incidents</a>
    </p>
  </div>

  <div class="row">
    <div class="col card">
      <h3>Scores (Top)</h3>
      <ul id="scores"></ul>
    </div>
    <div class="col card">
      <h3>Narratives (Latest)</h3>
      <ul id="narratives"></ul>
    </div>
  </div>

  <div class="card">
    <h3>Velocity Chart <span class="pill" id="lastUpdate">—</span></h3>
    <canvas id="chart" height="120"></canvas>
  </div>

  <div class="card">
    <h3>Incidents</h3>
    <ul id="incidents"></ul>
  </div>
</div>

<script>
const scoresEl = document.getElementById('scores');
const narrativesEl = document.getElementById('narratives');
const incidentsEl = document.getElementById('incidents');
const verEl = document.getElementById('ver');
const lastEl = document.getElementById('lastUpdate');

let chart, labels=[], dataSeries={};

async function init(){
  const health = await fetch('/health').then(r=>r.json());
  verEl.textContent = health.version + ' • ' + health.status;

  const ctx = document.getElementById('chart');
  chart = new Chart(ctx, {
    type: 'line',
    data: { labels: [], datasets: [] },
    options: { animation:false, scales:{ y:{ beginAtZero:true } } }
  });

  // initial fill
  refreshLists();
  setInterval(refreshLists, 15000);

  // live stream
  const es = new EventSource('/stream');
  es.addEventListener('update', (e)=>{
    const payload = JSON.parse(e.data);
    if(payload.scores){ updateChart(payload.scores); renderScores(payload.scores); }
    if(payload.narratives){ renderNarratives(payload.narratives); }
    lastEl.textContent = new Date().toLocaleTimeString();
  });
}

async function refreshLists(){
  const s = await fetch('/api/scores').then(r=>r.json()).catch(()=>({data:[]}));
  const n = await fetch('/api/narratives').then(r=>r.json()).catch(()=>({data:[]}));
  const i = await fetch('/api/incidents').then(r=>r.json()).catch(()=>({data:[]}));
  renderScores(s.data||[]);
  renderNarratives(n.data||[]);
  renderIncidents(i.data||[]);
}

function renderScores(items){
  scoresEl.innerHTML = '';
  items.slice(0,8).forEach(it=>{
    const li = document.createElement('li');
    li.textContent = `${it.name} — score ${it.score} | v ${it.velocity} | trust ${it.trust}`;
    scoresEl.appendChild(li);
  });
}

function renderNarratives(items){
  narrativesEl.innerHTML = '';
  items.slice(-10).reverse().forEach(it=>{
    const li = document.createElement('li');
    li.textContent = `[${it.source}] ${it.title}`;
    narrativesEl.appendChild(li);
  });
}

function renderIncidents(items){
  incidentsEl.innerHTML = '';
  items.slice(-10).reverse().forEach(it=>{
    const li = document.createElement('li');
    li.textContent = `${new Date(it.t*1000).toLocaleTimeString()} — ${it.kind}: ${it.message}`;
    incidentsEl.appendChild(li);
  });
}

function updateChart(scores){
  const now = new Date().toLocaleTimeString();
  if(!labels.includes(now)) labels.push(now);
  if(labels.length>40) labels.shift();

  const byName = {};
  scores.forEach(s => byName[s.name] = s.velocity);

  Object.keys(byName).forEach(name=>{
    if(!dataSeries[name]){
      dataSeries[name] = { label: name, borderWidth: 1, data: [], tension: 0.2 };
      chart.data.datasets.push(dataSeries[name]);
    }
  });

  chart.data.datasets.forEach(ds=>{
    const v = byName[ds.label] ?? null;
    ds.data.push(v);
    if(ds.data.length>labels.length) ds.data.shift();
  });

  chart.data.labels = labels;
  chart.update();
}

init();
</script>
</body>
</html>
